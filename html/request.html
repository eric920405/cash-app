<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="css/bootstrap.css">
	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/popper.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/fdb-all.min.js"></script>
	<script src="js/sweetalert.min.js"></script>
	<script src="js/Chart.js"></script>
</head>
<body style="font-family:Microsoft JhengHei;">
	<canvas id="lineChart"></canvas>
</div>
</body>
<script>
	var fdb = new ForerunnerDB();
	var db = fdb.db("db");
	var costList = db.collection("cost");
	var incomeList = db.collection("income");
	try{costList.load();incomeList.load();}catch(err){}
	setTimeout(function(){},10000);
	appendThisYear(costList.find(),incomeList.find());
	function appendThisYear(cost,income){
		var target = document.querySelector("#lineChart").getContext("2d");
		var event = new Chart(target,{
			type:"line",
			data:{
				labels:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],
				datasets:[{
					label:"支出",
					backgroundColor:"rgba(244,92,66,0.8)",
					borderColor:"rgb(244,92,66)",
					data: monthData(cost)
				},{
					label:"收入",
					backgroundColor:"rgba(104,244,65,0.8)",
					borderColor:"rgb(104,244,65)",
					data: monthData(income)
				},{
					label:"結算",
					backgroundColor:"rgba(65,244,232,0.8)",
					borderColor:"rgb(65,244,232)",
					data: total(cost,income)
				}]
			}
		});
		return [cost,income];
	}
	function monthData(List){
		var array = [];
		for(var i = 1;i<=12;i++){
			array.push(monthCount(List,i));
		}
		return array;
	}
	function monthCount(array,month){
		var date = new Date();
		if(month<10){
			month = "0" + month;
		}
		var firstDate = date.getUTCFullYear() + "-" + month + "-01";
		var lastDate = date.getUTCFullYear() + "-" + month + "-31";
		var count = 0;
		for(var i = 0;i<array.length;i++){
			if(firstDate<array[i].date&&array[i].date<lastDate){
				count += array[i].amount;
			}
		}
		return count;
	}
	function total(cost,income){
		var list = [];
		for(var i = 1;i<=12;i++){
			list.push(totalMonth(cost,income,i));
		}
		return list;
	}
	function totalMonth(cost,income,month){
		var date = new Date();
		if(month<10){
			month = "0" + month;
		}
		var firstDate = date.getUTCFullYear() + "-" + month + "-01";
		var lastDate = date.getUTCFullYear() + "-" + month + "-31";
		var count = 0;
		for(var i = 0;i<cost.length;i++){
			if(firstDate<cost[i].date&&cost[i].date<lastDate){
				count -= cost[i].amount;
			}
		}
		for(var i = 0;i<income.length;i++){
			if(firstDate<income[i].date&&income[i].date<lastDate){
				count += income[i].amount;
			}
		}
		return count;
	}
</script>